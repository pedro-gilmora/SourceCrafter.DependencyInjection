name: 'SourceCrafter.DependencyInjection: Build, Test & Deploy for .NET 8'

on:
  push:
    branches: [ "**" ]

jobs:
  try-deliver:
    name: '.NET 8 Build, Test & Deploy'
    runs-on: 'ubuntu-latest'

    steps:      
    - name: Get source code
      uses: actions/checkout@v3
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x

    - name: Restore, Package and Test
      shell: pwsh
      run: .\Package.ps1 -clean false -test true
      
    - name: Publish generator and endpoints to Nuget
      if: github.ref_name == 'dev'
      run: |        
        for package in $(find . -wholename '**/packaging/*.nupkg'); do
          # Execute nuget push for each package
          dotnet nuget push $package --api-key ${{ secrets.NUGET_API_KEY }} --source "https://api.nuget.org/v3/index.json"
        done

    - name: Notify Telegram
      shell: pwsh      
      run: |
        $message = @"
        🚀⚙️ Build ${{ github.workflow }} ${{ github.run_number }} ${{ job.status == 'failure' ? 'failed' : 'successfully completed' }}
        👤 Triggered by ${{ github.actor }}
        🌿 Branch: ${{ github.ref }}
        🔗 Commit: ${{ github.sha }}
        📝 Commit Message: ${{ github.event.head_commit.message }}
        "@

        $uri = "https://api.telegram.org/bot${{ secrets.TGBOT_TOKEN }}/sendMessage"
        $body = @{
            chat_id = ${{ secrets.SC_CHATID }}
            text    = $message
        }

        Invoke-RestMethod -Uri $uri -Method Post -Body $body
